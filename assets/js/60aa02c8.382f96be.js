"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[2321],{14899:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var o=n(83117),a=(n(67294),n(3905));const r={title:"Set Up Local Environment"},i=void 0,l={unversionedId:"contracts/v4/quickstart/hooks/setup",id:"contracts/v4/quickstart/hooks/setup",title:"Set Up Local Environment",description:"Before writing the hook let's first have a local environment properly configured e.g. deploying pool manager, utility routers and test tokens.",source:"@site/docs/contracts/v4/quickstart/04-hooks/00-setup.mdx",sourceDirName:"contracts/v4/quickstart/04-hooks",slug:"/contracts/v4/quickstart/hooks/setup",permalink:"/docs/contracts/v4/quickstart/hooks/setup",editUrl:"https://github.com/hoffms/docs/tree/main/docs/contracts/v4/quickstart/04-hooks/00-setup.mdx",tags:[],version:"current",sidebarPosition:0,frontMatter:{title:"Set Up Local Environment"},sidebar:"contractsSidebar",previous:{title:"Swap",permalink:"/docs/contracts/v4/quickstart/swap"},next:{title:"Swap Hooks",permalink:"/docs/contracts/v4/quickstart/hooks/swap"}},s={},p=[{value:"Setting up Foundry",id:"setting-up-foundry",level:2},{value:"Compile a Basic Hook Contract",id:"compile-a-basic-hook-contract",level:2},{value:"Local Node via Anvil",id:"local-node-via-anvil",level:2}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Before writing the hook let's first have a local environment properly configured e.g. deploying pool manager, utility routers and test tokens. "),(0,a.kt)("p",null,"At the end of this guide a development environment will be set up to be used to build the rest of the examples in the Guides section of the docs."),(0,a.kt)("p",null,"To get started as quickly as possible for building Uniswap v4 hooks, there is a ",(0,a.kt)("inlineCode",{parentName:"p"},"Quick Start")," section below to clone a boilerplate and get building. To start from scratch and learn the underlying concepts, jump to the ",(0,a.kt)("inlineCode",{parentName:"p"},"Start from Scratch")," section."),(0,a.kt)("h1",{id:"quick-start"},"Quick Start"),(0,a.kt)("p",null,"The Uniswap ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/uniswapfoundation/v4-template"},"v4-template repo")," provides a basic foundry environment with required imports already pre-loaded. Click on ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/new?template_name=v4-template&template_owner=uniswapfoundation"},(0,a.kt)("inlineCode",{parentName:"a"},"Use this template"))," to create a new repository with it."),(0,a.kt)("p",null,"Or simply clone it and install the dependencies:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/uniswapfoundation/v4-template.git\ncd v4-template\n# requires foundry\nforge install\nforge test\n")),(0,a.kt)("p",null,"Then hop to the ",(0,a.kt)("a",{parentName:"p",href:"#local-node-via-anvil"},"Local Node via Anvil")," to complete the set up and start developing."),(0,a.kt)("hr",null),(0,a.kt)("h1",{id:"start-from-scratch"},"Start from Scratch"),(0,a.kt)("p",null,"In the following sections, let's walk through the steps to create the same environment set up as the boilerplate from scratch and learn the underlying concepts."),(0,a.kt)("h2",{id:"setting-up-foundry"},"Setting up Foundry"),(0,a.kt)("p",null,"First thing is to set up a new Foundry project. "),(0,a.kt)("p",null,"If there is no Foundry installed - follow the ",(0,a.kt)("a",{parentName:"p",href:"https://book.getfoundry.sh/getting-started/installation"},"Foundry Book")," for installation."),(0,a.kt)("p",null,"Once Foundry is setup, initialize a new project:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"forge init counter-hook\ncd counter-hook\n")),(0,a.kt)("p",null,"Then install the Uniswap ",(0,a.kt)("inlineCode",{parentName:"p"},"v4-core")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"v4-periphery")," contracts as dependencies:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"forge install Uniswap/v4-core && forge install Uniswap/v4-periphery\n")),(0,a.kt)("p",null,"Next, set up the remappings so that the shorthand syntax for importing contracts from the dependencies work nicely:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"forge remappings > remappings.txt\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If there is something wrong with the inferred remappings, please replace with the following in ",(0,a.kt)("inlineCode",{parentName:"p"},"remappings.txt"),":")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"@uniswap/v4-core/=lib/v4-core/\nforge-gas-snapshot/=lib/v4-core/lib/forge-gas-snapshot/src/\nforge-std/=lib/v4-core/lib/forge-std/src/\npermit2/=lib/v4-periphery/lib/permit2/\nsolmate/=lib/v4-core/lib/solmate/\nv4-core/=lib/v4-core/\nv4-periphery/=lib/v4-periphery/\n")),(0,a.kt)("p",null,"After that, remove the default Counter contract and its associated test and script file that Foundry initially set up. To do that, either manually delete those files, or just run the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"rm ./**/Counter*.sol\n")),(0,a.kt)("p",null,"Finally, since v4 uses transient storage which is only available after Ethereum's cancun hard fork and on Solidity versions >= 0.8.24 - some config must be set in ",(0,a.kt)("inlineCode",{parentName:"p"},"foundry.toml")," config file. "),(0,a.kt)("p",null,"To do that, add the following lines to ",(0,a.kt)("inlineCode",{parentName:"p"},"foundry.toml"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-toml"},'# foundry.toml\n\nsolc_version = "0.8.26"\nevm_version = "cancun"\nffi = true\n')),(0,a.kt)("p",null,"Awesome! Now it's all set to start building the hook! Let\u2019s run a quick test to confirm everything is set up properly."),(0,a.kt)("h2",{id:"compile-a-basic-hook-contract"},"Compile a Basic Hook Contract"),(0,a.kt)("p",null,"To confirm that the environment is configured correctly let's write a basic Counter Hook contract. Create a new file, ",(0,a.kt)("inlineCode",{parentName:"p"},"./src/CounterHook.sol")," and paste the following code into it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-solidity"},'// SPDX-License-Identifier: MIT\npragma solidity ^0.8.24;\n\nimport {BaseHook} from "v4-periphery/src/utils/BaseHook.sol";\n\nimport {Hooks} from "v4-core/src/libraries/Hooks.sol";\nimport {IPoolManager} from "v4-core/src/interfaces/IPoolManager.sol";\nimport {PoolKey} from "v4-core/src/types/PoolKey.sol";\nimport {PoolId, PoolIdLibrary} from "v4-core/src/types/PoolId.sol";\nimport {BalanceDelta} from "v4-core/src/types/BalanceDelta.sol";\nimport {BeforeSwapDelta, BeforeSwapDeltaLibrary} from "v4-core/src/types/BeforeSwapDelta.sol";\n\ncontract CounterHook is BaseHook {\n    using PoolIdLibrary for PoolKey;\n\n    // NOTE: ---------------------------------------------------------\n    // state variables should typically be unique to a pool\n    // a single hook contract should be able to service multiple pools\n    // ---------------------------------------------------------------\n\n    mapping(PoolId => uint256 count) public beforeSwapCount;\n    mapping(PoolId => uint256 count) public afterSwapCount;\n\n    mapping(PoolId => uint256 count) public beforeAddLiquidityCount;\n    mapping(PoolId => uint256 count) public beforeRemoveLiquidityCount;\n\n    constructor(IPoolManager _poolManager) BaseHook(_poolManager) {}\n\n    function getHookPermissions() public pure override returns (Hooks.Permissions memory) {\n        return Hooks.Permissions({\n            beforeInitialize: false,\n            afterInitialize: false,\n            beforeAddLiquidity: true,\n            afterAddLiquidity: false,\n            beforeRemoveLiquidity: true,\n            afterRemoveLiquidity: false,\n            beforeSwap: true,\n            afterSwap: true,\n            beforeDonate: false,\n            afterDonate: false,\n            beforeSwapReturnDelta: false,\n            afterSwapReturnDelta: false,\n            afterAddLiquidityReturnDelta: false,\n            afterRemoveLiquidityReturnDelta: false\n        });\n    }\n\n    // -----------------------------------------------\n    // NOTE: see IHooks.sol for function documentation\n    // -----------------------------------------------\n\n    function _beforeSwap(address, PoolKey calldata key, IPoolManager.SwapParams calldata, bytes calldata)\n        internal\n        override\n        returns (bytes4, BeforeSwapDelta, uint24)\n    {\n        beforeSwapCount[key.toId()]++;\n        return (BaseHook.beforeSwap.selector, BeforeSwapDeltaLibrary.ZERO_DELTA, 0);\n    }\n\n    function _afterSwap(address, PoolKey calldata key, IPoolManager.SwapParams calldata, BalanceDelta, bytes calldata)\n        internal\n        override\n        returns (bytes4, int128)\n    {\n        afterSwapCount[key.toId()]++;\n        return (BaseHook.afterSwap.selector, 0);\n    }\n\n    function _beforeAddLiquidity(\n        address,\n        PoolKey calldata key,\n        IPoolManager.ModifyLiquidityParams calldata,\n        bytes calldata\n    ) internal override returns (bytes4) {\n        beforeAddLiquidityCount[key.toId()]++;\n        return BaseHook.beforeAddLiquidity.selector;\n    }\n\n    function _beforeRemoveLiquidity(\n        address,\n        PoolKey calldata key,\n        IPoolManager.ModifyLiquidityParams calldata,\n        bytes calldata\n    ) internal override returns (bytes4) {\n        beforeRemoveLiquidityCount[key.toId()]++;\n        return BaseHook.beforeRemoveLiquidity.selector;\n    }\n}\n')),(0,a.kt)("p",null,"To compile the Counter Hook contracts in the ",(0,a.kt)("inlineCode",{parentName:"p"},"./src")," folder, use the foundry build command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"forge build\n")),(0,a.kt)("p",null,"If the environment is compiled correctly it will display a message:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Compiler run successful!\n")),(0,a.kt)("h2",{id:"local-node-via-anvil"},"Local Node via Anvil"),(0,a.kt)("p",null,"Other than writing unit tests, ",(0,a.kt)("a",{parentName:"p",href:"https://book.getfoundry.sh/anvil/"},"Anvil")," can be used to deploy and test hooks."),(0,a.kt)("p",null,"With the local node up and running, use the ",(0,a.kt)("inlineCode",{parentName:"p"},"--rpc-url 127.0.0.1:8545")," flag in tests to point the Foundry testing suite to that local node:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# start anvil, a local EVM chain\nanvil\n\n# in a new terminal\n# foundry script for deploying v4 & hooks to anvil\nforge script script/Anvil.s.sol \\\n    --rpc-url http://localhost:8545 \\\n    --private-key <test_wallet_private_key> \\\n    --broadcast\n\n# test on the anvil local node\nforge test --rpc-url 127.0.0.1:8545\n")),(0,a.kt)("h1",{id:"next-steps"},"Next Steps"),(0,a.kt)("p",null,"With the environment set up ready to be built on. Jump over to the guides section to learn about the Uniswap functions that can be integrated with Hook. Remember to add all contracts (.sol files) to the ",(0,a.kt)("inlineCode",{parentName:"p"},"./src")," folder and their subsequent tests to the ",(0,a.kt)("inlineCode",{parentName:"p"},"./test")," folder. Then test them against the local anvil node by running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"forge test --rpc-url 127.0.0.1:8545\n")),(0,a.kt)("h1",{id:"appendix-openzeppelin-hooks-library"},"Appendix: OpenZeppelin Hooks Library"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("a",{parentName:"p",href:"https://docs.openzeppelin.com/uniswap-hooks/1.x/"},"OpenZeppelin Hooks Library"),", included in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/uniswapfoundation/v4-template"},"v4-template"),", provides secure and modular reference implementations for Uniswap v4 Hooks!")),(0,a.kt)("p",null,"If you're starting from scratch, you can install the OpenZeppelin Hooks library:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ forge install OpenZeppelin/uniswap-hooks\n")),(0,a.kt)("p",null,"The library includes:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseHook"),": Core scaffolding with security checks and permission management"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseCustomAccounting"),": For implementing hook-owned liquidity and custom token accounting"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseCustomCurve"),": For replacing default concentrated liquidity math with custom swap logic"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseAsyncSwap"),": For implementing non-atomic and asynchronous swaps"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseDynamicFee"),": For implementing dynamic fee pools"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseOverrideFee"),": For implementing dynamic fees on every swap"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"BaseDynamicAfterFee"),": For implementing post-swap fee adjustments based on actual swap output")))}u.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=a,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return n?o.createElement(f,i(i({ref:t},c),{},{components:n})):o.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);