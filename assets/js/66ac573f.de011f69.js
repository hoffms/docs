"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[12515],{25511:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=n(83117),r=(n(67294),n(3905));const o={id:"routing",title:"Routing a Swap"},i=void 0,s={unversionedId:"sdk/v3/guides/swaps/routing",id:"sdk/v3/guides/swaps/routing",title:"Routing a Swap",description:"Introduction",source:"@site/docs/sdk/v3/guides/swaps/03-routing.md",sourceDirName:"sdk/v3/guides/swaps",slug:"/sdk/v3/guides/swaps/routing",permalink:"/docs/sdk/v3/guides/swaps/routing",editUrl:"https://github.com/uniswap/uniswap-docs/tree/main/docs/sdk/v3/guides/swaps/03-routing.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"routing",title:"Routing a Swap"},sidebar:"sdkSidebar",previous:{title:"Executing a Trade",permalink:"/docs/sdk/v3/guides/swaps/trading"},next:{title:"Liquidity Positions",permalink:"/docs/sdk/v3/guides/liquidity/position-data"}},p={},u=[{value:"Introduction",id:"introduction",level:2},{value:"Creating a router instance",id:"creating-a-router-instance",level:2},{value:"Creating a route",id:"creating-a-route",level:2},{value:"Swapping using a route",id:"swapping-using-a-route",level:2},{value:"Next Steps",id:"next-steps",level:2}],l={toc:u};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"This guide will cover how to use Uniswap's smart order router to compute optimal routes and execute swaps. Rather than trading between a single pool, smart routing may use multiple hops (as many as needed) to ensure that the end result of the swap is the optimal price. It is based on the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/tree/main/v3-sdk/routing"},"routing code example"),", found in the Uniswap code examples ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples"},"repository"),". To run this example, check out the guide's ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/blob/main/v3-sdk/routing/README.md"},"README")," and follow the setup instructions."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If you need a briefer on the SDK and to learn more about how these guides connect to the examples repository, please visit our ",(0,r.kt)("a",{parentName:"p",href:"./01-background.md"},"background")," page!"))),(0,r.kt)("p",null,"In this example we will trade between ",(0,r.kt)("strong",{parentName:"p"},"WETH and USDC"),", but you can configure your example to use any two currencies and amount of input currency."),(0,r.kt)("p",null,"The guide will ",(0,r.kt)("strong",{parentName:"p"},"cover"),":"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Creating a router instance"),(0,r.kt)("li",{parentName:"ol"},"Creating a route"),(0,r.kt)("li",{parentName:"ol"},"Swapping using a route")),(0,r.kt)("p",null,"At the end of the guide, we should be able to create a route and and execute a swap between any two currencies tokens using the example's included UI."),(0,r.kt)("p",null,"For this guide, the following Uniswap packages are used:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/v3-sdk"},(0,r.kt)("inlineCode",{parentName:"a"},"@uniswap/v3-sdk"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/sdk-core"},(0,r.kt)("inlineCode",{parentName:"a"},"@uniswap/sdk-core"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/smart-order-router"},(0,r.kt)("inlineCode",{parentName:"a"},"@uniswap/smart-order-router")))),(0,r.kt)("p",null,"The core code of this guide can be found in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/blob/main/v3-sdk/routing/src/libs/routing.ts"},(0,r.kt)("inlineCode",{parentName:"a"},"routing.ts"))),(0,r.kt)("p",null,"The config, which we will use in some code snippets in this guides has this structure:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Token } from '@uniswap/sdk-core'\n\ninterface ExampleConfig {\n  env: Environment\n  rpc: {\n    local: string\n    mainnet: string\n  }\n  wallet: {\n    address: string\n    privateKey: string\n  }\n  tokens: {\n    in: Token\n    amountIn: number\n    out: Token\n  }\n}\n\nexport const CurrentConfig: ExampleConfig = {...}\n")),(0,r.kt)("h2",{id:"creating-a-router-instance"},"Creating a router instance"),(0,r.kt)("p",null,"To compute our route, we will use the ",(0,r.kt)("inlineCode",{parentName:"p"},"@uniswap/smart-order-router")," package, specifically the ",(0,r.kt)("inlineCode",{parentName:"p"},"AlphaRouter")," class which requires a ",(0,r.kt)("inlineCode",{parentName:"p"},"chainId")," and a ",(0,r.kt)("inlineCode",{parentName:"p"},"provider"),". Note that routing is not supported for local forks, so we will use a mainnet provider even when swapping on a local fork:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { AlphaRouter, ChainId } from '@uniswap/smart-order-router'\n\nconst provider = new ethers.providers.JsonRpcProvider(rpcUrl)\n\nconst router = new AlphaRouter({\n  chainId: ChainId.MAINNET,\n  provider,\n})\n")),(0,r.kt)("h2",{id:"creating-a-route"},"Creating a route"),(0,r.kt)("p",null,"We will use the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/v3-periphery/blob/v1.0.0/contracts/SwapRouter.sol"},"SwapRouter02")," for our trade.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"smart-order-router")," package provides us with a ",(0,r.kt)("inlineCode",{parentName:"p"},"SwapOptionsSwapRouter02")," interface, defining the wallet to use, slippage tolerance, and deadline for the transaction that we need to interact with the contract:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SwapOptionsSwapRouter02, SwapType } from '@uniswap/smart-order-router'\nimport { Percent } from '@uniswap/sdk-core'\n\nconst options: SwapOptionsSwapRouter02 = {\n  recipient: CurrentConfig.wallet.address,\n  slippageTolerance: new Percent(50, 10_000),\n  deadline: Math.floor(Date.now() / 1000 + 1800),\n  type: SwapType.SWAP_ROUTER_02,\n}\n")),(0,r.kt)("p",null,"Like explained in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/sdk/v3/guides/swaps/trading#executing-a-trade"},"previous guide"),", it is important to set the parameters to sensible values."),(0,r.kt)("p",null,"Using these options, we can now create a trade (",(0,r.kt)("inlineCode",{parentName:"p"},"TradeType.EXACT_INPUT")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"TradeType.EXACT_OUTPUT"),") with the currency and the input amount to use to get a quote. For this example, we'll use an ",(0,r.kt)("inlineCode",{parentName:"p"},"EXACT_INPUT")," trade to get a quote outputted in the quote currency."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { CurrencyAmount, TradeType } from '@uniswap/sdk-core'\n\nconst rawTokenAmountIn: JSBI = fromReadableAmount(\n      CurrentConfig.currencies.amountIn,\n      CurrentConfig.currencies.in.decimals\n    )\n\nconst route = await router.route(\n  CurrencyAmount.fromRawAmount(\n    CurrentConfig.currencies.in,\n    rawTokenAmountIn\n  ),\n  CurrentConfig.currencies.out,\n  TradeType.EXACT_INPUT,\n  options\n)\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"fromReadableAmount")," function calculates the amount of tokens in the Token's smallest unit from the full unit and the Token's decimals:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/libs/conversion.ts"',title:'"src/libs/conversion.ts"'},"export function fromReadableAmount(amount: number, decimals: number): JSBI {\n  const extraDigits = Math.pow(10, countDecimals(amount))\n  const adjustedAmount = amount * extraDigits\n  return JSBI.divide(\n    JSBI.multiply(\n      JSBI.BigInt(adjustedAmount),\n      JSBI.exponentiate(JSBI.BigInt(10), JSBI.BigInt(decimals))\n    ),\n    JSBI.BigInt(extraDigits)\n  )\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"route")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"route.methodParameters")," are ",(0,r.kt)("em",{parentName:"p"},"optional")," as the request can fail, for example if ",(0,r.kt)("strong",{parentName:"p"},"no route exists")," between the two Tokens or because of networking issues.\nWe check if the call was succesful:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"if (!route || !route.methodParameters) {\n    // Handle failed request\n}\n")),(0,r.kt)("p",null,"Depending on our preferences and reason for the issue we could retry the request or throw an Error."),(0,r.kt)("h2",{id:"swapping-using-a-route"},"Swapping using a route"),(0,r.kt)("p",null,"First, we need to give approval to the ",(0,r.kt)("inlineCode",{parentName:"p"},"SwapRouter")," smart contract to spend our tokens for us:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ethers } from 'ethers'\n...\n\nconst wallet = new ethers.Wallet(privateKey, provider)\nconst tokenContract = new ethers.Contract(\n    CurrentConfig.tokens.in.address, \n    ERC20ABI, \n    wallet\n)\nconst tokenApproval = await tokenContract.approve(\n    V3_SWAP_ROUTER_ADDRESS, \n    ethers.BigNumber.from(rawTokenAmountIn.toString())\n)\n")),(0,r.kt)("p",null,"To be able to spend the tokens of a wallet, a smart contract first needs to get an approval from that wallet.\nERC20 tokens have an ",(0,r.kt)("inlineCode",{parentName:"p"},"approve")," function that accepts the address of the smart contract that we want to allow spending our tokens and the amount the smart contract should be allowed to spend."),(0,r.kt)("p",null,"We can get the ",(0,r.kt)("strong",{parentName:"p"},"V3_SWAP_ROUTER_ADDRESS")," for our chain from ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/v3-periphery/blob/main/deploys.md"},"GitHub"),".\nKeep in mind that different chains might have ",(0,r.kt)("strong",{parentName:"p"},"different deployment addresses")," for the same contracts.\nThe deployment address for local forks of a network are the same as in the network you forked, so for a ",(0,r.kt)("strong",{parentName:"p"},"fork of mainnet")," it would be the address for ",(0,r.kt)("strong",{parentName:"p"},"Mainnet"),"."),(0,r.kt)("p",null,"We need to wait one block for the approval transaction to be included by the blockchain."),(0,r.kt)("p",null,"Once the approval has been granted, we can now execute the trade using the route's computed calldata, values, and gas values:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const txRes = await wallet.sendTransaction({\n  data: route.methodParameters.calldata,\n  to: V3_SWAP_ROUTER_ADDRESS,\n  value: route.methodParameters.value,\n  from: wallet.address,\n  maxFeePerGas: MAX_FEE_PER_GAS,\n  maxPriorityFeePerGas: MAX_PRIORITY_FEE_PER_GAS,\n})\n")),(0,r.kt)("p",null,"After swapping, you should see the currency balances update in the UI shortly after the block is confirmed."),(0,r.kt)("p",null,"You can find the full code in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/blob/main/v3-sdk/routing/src/libs/routing.ts"},(0,r.kt)("inlineCode",{parentName:"a"},"routing.ts")),"."),(0,r.kt)("h2",{id:"next-steps"},"Next Steps"),(0,r.kt)("p",null,"Now that you're familiar with trading, consider checking out our next guides on ",(0,r.kt)("a",{parentName:"p",href:"/docs/sdk/v3/guides/liquidity/position-data"},"pooling liquidity")," to Uniswap!"))}c.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),u=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=u(e.components);return a.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,h=d["".concat(p,".").concat(m)]||d[m]||c[m]||o;return n?a.createElement(h,i(i({ref:t},l),{},{components:n})):a.createElement(h,i({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);