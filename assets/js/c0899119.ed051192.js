"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[14921],{24486:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(83117),o=(n(67294),n(3905));const r={id:"swap-and-add",title:"Swapping and Adding Liquidity"},i=void 0,s={unversionedId:"sdk/v3/guides/liquidity/swap-and-add",id:"sdk/v3/guides/liquidity/swap-and-add",title:"Swapping and Adding Liquidity",description:"Introduction",source:"@site/docs/sdk/v3/guides/liquidity/06-swap-and-add-liquidity.md",sourceDirName:"sdk/v3/guides/liquidity",slug:"/sdk/v3/guides/liquidity/swap-and-add",permalink:"/docs/sdk/v3/guides/liquidity/swap-and-add",editUrl:"https://github.com/uniswap/uniswap-docs/tree/main/docs/sdk/v3/guides/liquidity/06-swap-and-add-liquidity.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"swap-and-add",title:"Swapping and Adding Liquidity"},sidebar:"sdkSidebar",previous:{title:"Collecting Fees",permalink:"/docs/sdk/v3/guides/liquidity/liquidity-fees"},next:{title:"Introduction",permalink:"/docs/sdk/v3/guides/advanced/introduction"}},p={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Setup a router instance",id:"setup-a-router-instance",level:2},{value:"Configuring our ratio calculation",id:"configuring-our-ratio-calculation",level:2},{value:"Calculating our currency ratio",id:"calculating-our-currency-ratio",level:2},{value:"Constructing and executing our swap-and-add transaction",id:"constructing-and-executing-our-swap-and-add-transaction",level:2}],l={toc:d};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"This guide will cover how to execute a swap-and-add operation in a single atomic transaction. It is based on the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/tree/main/v3-sdk/swap-and-add-liquidity"},"swap-and-add example"),", found in the Uniswap code examples ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples"},"repository"),". To run this example, check out the examples's ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/tree/main/v3-sdk/swap-and-add-liquidity"},"README")," and follow the setup instructions."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If you need a briefer on the SDK and to learn more about how these guides connect to the examples repository, please visit our ",(0,o.kt)("a",{parentName:"p",href:"/docs/sdk/v3/guides/background"},"background")," page!"))),(0,o.kt)("p",null,"When adding liquidity to a Uniswap v3 pool, you must provide two assets in a particular ratio. In many cases, your contract or the user's wallet hold a different ratio of those two assets. In order to deposit 100% of your assets, you must first swap your assets to the optimal ratio and then add liquidity."),(0,o.kt)("p",null,"However, the swap may shift the balance of the pool and thus change the optimal ratio. To avoid that, we can execute this swap-and-add liquidity operation in an atomic fashion, using a router. The inputs to our guide are the ",(0,o.kt)("strong",{parentName:"p"},"two tokens")," that we are pooling for, the ",(0,o.kt)("strong",{parentName:"p"},"amount")," of each token we are pooling for, the ",(0,o.kt)("strong",{parentName:"p"},"amount")," of each token to swap-and-add, and the Pool ",(0,o.kt)("strong",{parentName:"p"},"fee"),"."),(0,o.kt)("p",null,"The guide will ",(0,o.kt)("strong",{parentName:"p"},"cover"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Setup a router instance"),(0,o.kt)("li",{parentName:"ol"},"Configuring our ratio calculation"),(0,o.kt)("li",{parentName:"ol"},"Calculating our currency ratio"),(0,o.kt)("li",{parentName:"ol"},"Constructing and executing our swap-and-add transaction")),(0,o.kt)("p",null,"At the end of the guide, given the inputs above, we should be able swap-and-add liquidity using 100% of the input assets with the press of a button and see the change reflected in our position and the balance of our tokens."),(0,o.kt)("p",null,"For this guide, the following Uniswap packages are used:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/v3-sdk"},(0,o.kt)("inlineCode",{parentName:"a"},"@uniswap/v3-sdk"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/sdk-core"},(0,o.kt)("inlineCode",{parentName:"a"},"@uniswap/sdk-core"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/@uniswap/smart-order-router"},(0,o.kt)("inlineCode",{parentName:"a"},"@uniswap/smart-order-router")))),(0,o.kt)("p",null,"The core code of this guide can be found in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/examples/blob/main/v3-sdk/swap-and-add-liquidity/src/libs/liquidity.ts#L48"},(0,o.kt)("inlineCode",{parentName:"a"},"swapAndAddLiquidity()")),"."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This guide assumes you are familiar with our ",(0,o.kt)("a",{parentName:"p",href:"./01-minting-position.md"},"Minting a Position")," guide. A minted position is required to add or remove liquidity from, so the buttons will be disabled until a position is minted."),(0,o.kt)("p",{parentName:"div"},"Also note that we do not need to give approval to the ",(0,o.kt)("inlineCode",{parentName:"p"},"NonfungiblePositionManager")," to transfer our tokens as we will have already done that when minting our position."))),(0,o.kt)("h2",{id:"setup-a-router-instance"},"Setup a router instance"),(0,o.kt)("p",null,"The first step is to approve the ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapRouter")," smart contract to spend our tokens for us in order for us to add liquidity to our position:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const tokenInApproval = await getTokenTransferApproval(\n  token0,\n  V3_SWAP_ROUTER_ADDRESS\n)\n\nconst tokenOutApproval = await getTokenTransferApproval(\n  token1,\n  V3_SWAP_ROUTER_ADDRESS\n)\n")),(0,o.kt)("p",null,"We described the ",(0,o.kt)("inlineCode",{parentName:"p"},"getTokenTransferApproval")," function ",(0,o.kt)("a",{parentName:"p",href:"/docs/sdk/v3/guides/liquidity/minting#giving-approval-to-transfer-our-tokens"},"here"),"."),(0,o.kt)("p",null,"Then we can setup our router, the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/smart-order-router/blob/97c1bb7cb64b22ebf3509acda8de60c0445cf250/src/routers/alpha-router/alpha-router.ts#L333"},(0,o.kt)("inlineCode",{parentName:"a"},"AlphaRouter")),", which is part of the ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@uniswap/smart-order-router"},"smart-order-router package"),". The router requires a ",(0,o.kt)("inlineCode",{parentName:"p"},"chainId")," and a ",(0,o.kt)("inlineCode",{parentName:"p"},"provider")," to be initialized. Note that routing is not supported for local forks, so we will use a mainnet provider even when swapping on a local fork:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ethers } from 'ethers'\nimport { AlphaRouter } from '@uniswap/smart-order-router'\n\nconst provider = new ethers.providers.JsonRpcProvider(rpcUrl)\n\nconst router = new AlphaRouter({ chainId: 1, provider })\n")),(0,o.kt)("p",null,"For a more detailed example, check out our ",(0,o.kt)("a",{parentName:"p",href:"../trading/03-routing.md"},"routing guide"),"."),(0,o.kt)("h2",{id:"configuring-our-ratio-calculation"},"Configuring our ratio calculation"),(0,o.kt)("p",null,"Having created the router, we now need to construct the parameters required to make a call to its ",(0,o.kt)("inlineCode",{parentName:"p"},"routeToRatio")," function, which will ensure the ratio of currency used matches the pool's required ratio to add our total liquidity. This will require the following parameters:"),(0,o.kt)("p",null,"The first two parameters are the currency amounts we use as input to the ",(0,o.kt)("inlineCode",{parentName:"p"},"routeToRatio")," algorithm:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { CurrencyAmount } from '@uniswap/sdk-core'\n\nconst token0CurrencyAmount = CurrencyAmount.fromRawAmount(\n  token0,\n  fromReadableAmount(\n    token0AmountToAdd,\n    token0.decimals\n  )\n)\n\nconst token1CurrencyAmount = CurrencyAmount.fromRawAmount(\n  token1,\n  fromReadableAmount(\n    token1AmountToAdd,\n    token1.decimals\n  )\n)\n")),(0,o.kt)("p",null,"Next, we will create a placeholder position with a liquidity of ",(0,o.kt)("inlineCode",{parentName:"p"},"1")," since liquidity is still unknown and will be set inside the call to ",(0,o.kt)("inlineCode",{parentName:"p"},"routeToRatio"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Pool, Position, nearestUsableTick } from '@uniswap/v3-sdk'\n\nconst placeholderPosition = new Position{\n    pool,\n    liquidity: 1,\n    tickLower:\n      nearestUsableTick(pool.tickCurrent, pool.tickSpacing) -\n      pool.tickSpacing * 2,\n    tickUpper:\n      nearestUsableTick(pool.tickCurrent, pool.tickSpacing) +\n      poolInfo.tickSpacing * 2\n}\n")),(0,o.kt)("p",null,"We then need to create an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapAndAddConfig")," which will set additional configuration parameters for the ",(0,o.kt)("inlineCode",{parentName:"p"},"routeToRatio")," algorithm:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ratioErrorTolerance")," determines the margin of error the resulting ratio can have from the optimal ratio."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"maxIterations")," determines the maximum times the algorithm will iterate to find a ratio within error tolerance. If max iterations is exceeded, an error is returned. The benefit of running the algorithm more times is that we have more chances to find a route, but more iterations will longer to execute. We've used a default of 6 in our example.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Fraction } from '@uniswap/sdk-core'\nimport { SwapAndAddConfig } from '@uniswap/smart-order-router'\n\nconst swapAndAddConfig: SwapAndAddConfig = {\n  ratioErrorTolerance: new Fraction(1, 100),\n  maxIterations: 6,\n}\n")),(0,o.kt)("p",null,"Finally, we will create an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapAndAddOptions")," to configure which position we are adding liquidity to and our defined swapping parameters in two different objects:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"swapConfig"))," configures the ",(0,o.kt)("inlineCode",{parentName:"li"},"recipient")," of leftover dust from swap, ",(0,o.kt)("inlineCode",{parentName:"li"},"slippageTolerance")," and a ",(0,o.kt)("inlineCode",{parentName:"li"},"deadline")," for the swap."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"addLiquidityOptions"))," must contain a ",(0,o.kt)("inlineCode",{parentName:"li"},"tokenId")," to add to an existing position")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SwapAndAddOptions } from '@uniswap/smart-order-router'\n\nconst swapAndAddOptions: SwapAndAddOptions = {\n  swapOptions: {\n    type: SwapType.SWAP_ROUTER_02,\n    recipient: address,\n    slippageTolerance: new Percent(50, 10_000),\n    deadline: Math.floor(Date.now() / 1000) + 60 * 20,\n  },\n  addLiquidityOptions: {\n    tokenId: positionId,\n  },\n}\n")),(0,o.kt)("h2",{id:"calculating-our-currency-ratio"},"Calculating our currency ratio"),(0,o.kt)("p",null,"Having constructed all the parameters we need to call ",(0,o.kt)("inlineCode",{parentName:"p"},"routeToRatio"),", we can now make the call to the function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SwapToRatioResponse } from '@uniswap/smart-order-router'\n\nconst routeToRatioResponse: SwapToRatioResponse = await router.routeToRatio(\n  token0CurrencyAmount,\n  token1CurrencyAmount,\n  currentPosition,\n  swapAndAddConfig,\n  swapAndAddOptions\n)\n")),(0,o.kt)("p",null,"The return type of the function call is ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/smart-order-router/blob/97c1bb7cb64b22ebf3509acda8de60c0445cf250/src/routers/router.ts#L121"},"SwapToRatioResponse"),". If a route was found successfully, this object will have two fields: the status (success) and the ",(0,o.kt)("inlineCode",{parentName:"p"},"SwapToRatioRoute")," object. We check to make sure that both of those conditions hold true before we construct and submit the transaction:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SwapToRatioStatus } from '@uniswap/smart-order-router'\n\nif (\n  !routeToRatioResponse ||\n  routeToRatioResponse.status !== SwapToRatioStatus.SUCCESS\n) {\n  // Handle Failed Transaction\n}\n")),(0,o.kt)("p",null,"In case a route was not found, we return from the function a ",(0,o.kt)("inlineCode",{parentName:"p"},"Failed")," state for the transaction."),(0,o.kt)("h2",{id:"constructing-and-executing-our-swap-and-add-transaction"},"Constructing and executing our swap-and-add transaction"),(0,o.kt)("p",null,"After making sure that a route was successfully found, we can now construct and send the transaction. The response (",(0,o.kt)("inlineCode",{parentName:"p"},"SwapToRatioRoute"),") will have the properties we need to construct our transaction object:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SwapToRatioRoute } from '@uniswap/smart-order-router'\n\nconst route: SwapToRatioRoute = routeToRatioResponse.result\nconst transaction = {\n  data: route.methodParameters?.calldata,\n  to: V3_SWAP_ROUTER_ADDRESS,\n  value: route.methodParameters?.value,\n  from: address,\n}\n\nconst txRes = await wallet.sendTransaction(transaction)\n")),(0,o.kt)("p",null,"If the transaction was successful, our swap-and-add will be completed! We should see our input token balances decrease and our position balance should be increased accordingly."))}u.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=a.createContext({}),d=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=d(e.components);return a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),c=d(n),m=o,h=c["".concat(p,".").concat(m)]||c[m]||u[m]||r;return n?a.createElement(h,i(i({ref:t},l),{},{components:n})):a.createElement(h,i({ref:t},l))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=c;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"}}]);