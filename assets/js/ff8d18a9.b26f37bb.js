"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[8540],{16139:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var n=o(83117),r=(o(67294),o(3905));const a={title:"Hook Deployment"},i=void 0,s={unversionedId:"contracts/v4/guides/hooks/hook-deployment",id:"contracts/v4/guides/hooks/hook-deployment",title:"Hook Deployment",description:"Hook Flags",source:"@site/docs/contracts/v4/guides/hooks/05-hook-deployment.mdx",sourceDirName:"contracts/v4/guides/hooks",slug:"/contracts/v4/guides/hooks/hook-deployment",permalink:"/docs/contracts/v4/guides/hooks/hook-deployment",editUrl:"https://github.com/hoffms/docs/tree/main/docs/contracts/v4/guides/hooks/05-hook-deployment.mdx",tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Hook Deployment"},sidebar:"contractsSidebar",previous:{title:"Building Your First Hook",permalink:"/docs/contracts/v4/guides/hooks/your-first-hook"},next:{title:"Unlock Callback & Deltas",permalink:"/docs/contracts/v4/guides/unlock-callback"}},l={},p=[{value:"Hook Flags",id:"hook-flags",level:2},{value:"Hook Miner",id:"hook-miner",level:2},{value:"A Complete Foundry Script Contract",id:"a-complete-foundry-script-contract",level:2}],c={toc:p};function d(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"hook-flags"},"Hook Flags"),(0,r.kt)("p",null,"As mentioned in ",(0,r.kt)("a",{parentName:"p",href:"/docs/contracts/v4/concepts/hooks"},"Concept of Hooks"),", hook contracts indicate their implemented functions by ",(0,r.kt)("strong",{parentName:"p"},"encoding its behavior in the address of the contract"),". The ",(0,r.kt)("inlineCode",{parentName:"p"},"PoolManager")," uses these permissions to determine which hook functions to call for a given pool."),(0,r.kt)("p",null,"Each hook function e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"beforeSwap")," - corresponds to a certain ",(0,r.kt)("em",{parentName:"p"},"flag"),". For example, the ",(0,r.kt)("inlineCode",{parentName:"p"},"beforeSwap")," function is correlated to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/v4-core/blob/main/src/libraries/Hooks.sol#L37"},(0,r.kt)("inlineCode",{parentName:"a"},"BEFORE_SWAP_FLAG"))," which has a value of ",(0,r.kt)("inlineCode",{parentName:"p"},"1 << 7"),"."),(0,r.kt)("p",null,"These flags represent specific bits in the address of the hook smart contract - and the value of the bit (a one or a zero) represents whether that flag is true or false. An example:"),(0,r.kt)("p",null,"Addresses on Ethereum are 20 bytes long (160 bits). So for example the address:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"0x00000000000000000000000000000000000000C0\n")),(0,r.kt)("p",null,"represented in binary is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 \n0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 \n0000 0000 0000 0000 0000 0000 1100 0000\n")),(0,r.kt)("p",null,"In binary it goes from right-to-left - so the trailing 8 bits of this address are ",(0,r.kt)("inlineCode",{parentName:"p"},"1100 0000")," where:"),(0,r.kt)("p",null,"1st Bit to 6th Bit = ",(0,r.kt)("inlineCode",{parentName:"p"},"0")),(0,r.kt)("p",null,"7th Bit and 8th Bit = ",(0,r.kt)("inlineCode",{parentName:"p"},"1")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"AFTER_SWAP")," flag is represented by the 7th bit - which is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," for the example contract address. In the ",(0,r.kt)("inlineCode",{parentName:"p"},"PoolManager")," swap execution flow, it will observe the flag and make a call to the hook's ",(0,r.kt)("inlineCode",{parentName:"p"},"afterSwap")," function."),(0,r.kt)("p",null,"Similarly, the 8th bit which is also a ",(0,r.kt)("inlineCode",{parentName:"p"},"1"),", actually corresponds to the ",(0,r.kt)("inlineCode",{parentName:"p"},"BEFORE_SWAP")," i.e. the ",(0,r.kt)("inlineCode",{parentName:"p"},"beforeSwap")," hook function - which will also be called by the ",(0,r.kt)("inlineCode",{parentName:"p"},"PoolManager")," during a ",(0,r.kt)("inlineCode",{parentName:"p"},"swap")," workflow."),(0,r.kt)("p",null,"A full list of all flags can be found ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/v4-core/blob/main/src/libraries/Hooks.sol"},"here"),"."),(0,r.kt)("h2",{id:"hook-miner"},"Hook Miner"),(0,r.kt)("p",null,"Because of encoded addresses, hook developers must ",(0,r.kt)("em",{parentName:"p"},"mine")," an address to a their particular pattern."),(0,r.kt)("p",null,"For local testing, ",(0,r.kt)("inlineCode",{parentName:"p"},"deployCodeTo")," cheatcode in Foundry can be used to deploy hook contract to any address. "),(0,r.kt)("p",null,"But when deploying hooks to an actual network, address mining is required to find the proper deployment address\nThere is a helper library ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/v4-periphery/blob/main/src/utils/HookMiner.sol"},(0,r.kt)("inlineCode",{parentName:"a"},"HookMiner.sol"))," that can be used to mine for correct addresses."),(0,r.kt)("p",null,"Let's see it in action for a Foundry script. We will make use of the example - Points Hook from ",(0,r.kt)("a",{parentName:"p",href:"/docs/contracts/v4/guides/hooks/your-first-hook"},"Building Your First Hook"),"."),(0,r.kt)("p",null,"First we set up the contract for Foundry script and import the relevant dependencies:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},'// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport "forge-std/Script.sol";\nimport {Hooks} from "v4-core/src/libraries/Hooks.sol";\nimport {IPoolManager} from "v4-core/src/interfaces/IPoolManager.sol";\nimport {HookMiner} from "v4-periphery/src/utils/HookMiner.sol";\n\nimport {Constants} from "./base/Constants.sol";\nimport {PointsHook} from "../src/PointsHook.sol";\n\n/// @notice Mines the address and deploys the PointsHook.sol Hook contract\ncontract PointsHookScript is Script, Constants {\n    function setUp() public {}\n\n    function run() public {\n')),(0,r.kt)("p",null,"Specify the flags needed to be encoded in the address:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"uint160 flags = uint160(\n    Hooks.AFTER_ADD_LIQUIDITY_FLAG | Hooks.AFTER_SWAP_FLAG\n);\n")),(0,r.kt)("p",null,"Mine the address by finding a ",(0,r.kt)("inlineCode",{parentName:"p"},"salt")," that produces a hook address with the desired ",(0,r.kt)("inlineCode",{parentName:"p"},"flags"),", use the Foundry deterministic deployer when deploying via Foundry script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"bytes memory constructorArgs = abi.encode(POOLMANAGER);\n(address hookAddress, bytes32 salt) =\n    HookMiner.find(CREATE2_DEPLOYER, flags, type(PointsHook).creationCode, constructorArgs);\n")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),(0,r.kt)("strong",{parentName:"h5"},"CREATE2_DEPLOYER"))),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("ul",{parentName:"div"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"CREATE2_DEPLOYER")," is the address that will deploy the hook. In ",(0,r.kt)("inlineCode",{parentName:"li"},"forge test"),", this will be the test contract ",(0,r.kt)("inlineCode",{parentName:"li"},"address(this)")," or the pranking address."),(0,r.kt)("li",{parentName:"ul"},"In ",(0,r.kt)("inlineCode",{parentName:"li"},"forge script"),", this should be ",(0,r.kt)("inlineCode",{parentName:"li"},"0x4e59b44847b379578588920cA78FbF26c0B4956C")," (CREATE2 Deployer Proxy)")))),(0,r.kt)("p",null,"Refer to this for more details on deploying contracts with CREATE2: ",(0,r.kt)("a",{parentName:"p",href:"https://docs.openzeppelin.com/cli/2.8/deploying-with-create2"},"Deploying Contracts with CREATE2")),(0,r.kt)("p",null,"Deploy the hook using CREATE2 with the ",(0,r.kt)("inlineCode",{parentName:"p"},"salt"),", and compare the deployed address with the address mined:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},'vm.broadcast();\nPointsHook pointsHook = new PointsHook{salt: salt}(IPoolManager(POOLMANAGER));\nrequire(address(pointsHook) == hookAddress, "PointsHookScript: hook address mismatch");\n')),(0,r.kt)("h2",{id:"a-complete-foundry-script-contract"},"A Complete Foundry Script Contract"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},'// SPDX-License-Identifier: MIT\npragma solidity ^0.8.19;\n\nimport "forge-std/Script.sol";\nimport {Hooks} from "v4-core/src/libraries/Hooks.sol";\nimport {IPoolManager} from "v4-core/src/interfaces/IPoolManager.sol";\nimport {HookMiner} from "v4-periphery/src/utils/HookMiner.sol";\n\nimport {Constants} from "./base/Constants.sol";\nimport {PointsHook} from "../src/PointsHook.sol";\n\n/// @notice Mines the address and deploys the PointsHook.sol Hook contract\ncontract PointsHookScript is Script, Constants {\n    function setUp() public {}\n\n    function run() public {\n        // hook contracts must have specific flags encoded in the address\n        uint160 flags = uint160(\n            Hooks.BEFORE_SWAP_FLAG | Hooks.AFTER_SWAP_FLAG | Hooks.BEFORE_ADD_LIQUIDITY_FLAG\n                | Hooks.BEFORE_REMOVE_LIQUIDITY_FLAG\n        );\n\n        // Mine a salt that will produce a hook address with the correct flags\n        bytes memory constructorArgs = abi.encode(POOLMANAGER);\n        (address hookAddress, bytes32 salt) =\n            HookMiner.find(CREATE2_DEPLOYER, flags, type(PointsHook).creationCode, constructorArgs);\n\n        // Deploy the hook using CREATE2\n        vm.broadcast();\n        PointsHook pointsHook = new PointsHook{salt: salt}(IPoolManager(POOLMANAGER));\n        require(address(pointsHook) == hookAddress, "PointsHookScript: hook address mismatch");\n    }\n}\n')))}d.isMDXComponent=!0},3905:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>m});var n=o(67294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},k=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),k=p(o),m=r,h=k["".concat(l,".").concat(m)]||k[m]||d[m]||a;return o?n.createElement(h,i(i({ref:t},c),{},{components:o})):n.createElement(h,i({ref:t},c))}));function m(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=k;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<a;p++)i[p]=o[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}k.displayName="MDXCreateElement"}}]);