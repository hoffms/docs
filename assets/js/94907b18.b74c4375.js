"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[4307],{99415:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var i=n(83117),o=(n(67294),n(3905));const r={id:"setting-up",title:"Set Up Your Contract",sidebar_position:1},a=void 0,s={unversionedId:"contracts/v3/guides/providing-liquidity/setting-up",id:"contracts/v3/guides/providing-liquidity/setting-up",title:"Set Up Your Contract",description:"Setting up the Contract",source:"@site/docs/contracts/v3/guides/providing-liquidity/setting-up-your-contract.md",sourceDirName:"contracts/v3/guides/providing-liquidity",slug:"/contracts/v3/guides/providing-liquidity/setting-up",permalink:"/docs/contracts/v3/guides/providing-liquidity/setting-up",editUrl:"https://github.com/hoffms/docs/tree/main/docs/contracts/v3/guides/providing-liquidity/setting-up-your-contract.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"setting-up",title:"Set Up Your Contract",sidebar_position:1},sidebar:"contractsSidebar",previous:{title:"Multihop Swaps",permalink:"/docs/contracts/v3/guides/swaps/multihop-swaps"},next:{title:"Mint a New Position",permalink:"/docs/contracts/v3/guides/providing-liquidity/mint-a-position"}},l={},p=[{value:"Setting up the Contract",id:"setting-up-the-contract",level:2},{value:"Allowing ERC721 Interactions",id:"allowing-erc721-interactions",level:2},{value:"The Constructor",id:"the-constructor",level:2},{value:"Allowing custody of ERC721 tokens",id:"allowing-custody-of-erc721-tokens",level:2},{value:"Creating a Deposit",id:"creating-a-deposit",level:2},{value:"The Full Contract Setup",id:"the-full-contract-setup",level:2}],c={toc:p};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"setting-up-the-contract"},"Setting up the Contract"),(0,o.kt)("p",null,"This guide is an example of a custodial contract Uniswap V3 positions, which allows interaction with the Uniswap V3 Periphery by minting a position, adding liquidity to a position, decreasing liquidity, and collecting fees."),(0,o.kt)("p",null,"First, declare the solidity version used to compile the contract and ",(0,o.kt)("inlineCode",{parentName:"p"},"abicoder v2")," to allow arbitrary nested arrays and structs to be encoded and decoded in calldata, a feature we use when transacting with a pool."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"// SPDX-License-Identifier: GPL-2.0-or-later\npragma solidity =0.7.6;\npragma abicoder v2;\n")),(0,o.kt)("p",null,"Import the contracts needed from the npm package installation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"import '@uniswap/v3-core/contracts/interfaces/IUniswapV3Pool.sol';\nimport '@uniswap/v3-core/contracts/libraries/TickMath.sol';\nimport '@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol';\nimport '@uniswap/v3-periphery/contracts/interfaces/ISwapRouter.sol';\nimport '@uniswap/v3-periphery/contracts/interfaces/INonfungiblePositionManager.sol';\nimport '@uniswap/v3-periphery/contracts/libraries/TransferHelper.sol';\nimport '@uniswap/v3-periphery/contracts/base/LiquidityManagement.sol';\n")),(0,o.kt)("p",null,"Create a contract called ",(0,o.kt)("inlineCode",{parentName:"p"},"LiquidityExamples")," and inherit both ",(0,o.kt)("inlineCode",{parentName:"p"},"IERC721Receiver")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"LiquidityManagement"),"."),(0,o.kt)("p",null,"We've chosen to hardcode the token contract addresses and pool fee tiers for our example. In production, you would likely use an input parameter for this, allowing you to change the pools and tokens you are interacting with on a per transaction basis."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"contract LiquidityExamples is IERC721Receiver {\n\n    address public constant DAI = 0x6B175474E89094C44Da98b954EedeAC495271d0F;\n    address public constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;\n\n    uint24 public constant poolFee = 3000;\n")),(0,o.kt)("p",null,"Declare an immutable public variable ",(0,o.kt)("inlineCode",{parentName:"p"},"nonfungiblePositionManager")," of type ",(0,o.kt)("inlineCode",{parentName:"p"},"INonfungiblePositionManager"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"    INonfungiblePositionManager public immutable nonfungiblePositionManager;\n")),(0,o.kt)("h2",{id:"allowing-erc721-interactions"},"Allowing ERC721 Interactions"),(0,o.kt)("p",null,"Every ",(0,o.kt)("a",{parentName:"p",href:"https://ethereum.org/en/nft/"},"NFT")," is identified by a unique uint256 ID inside the ERC-721 smart contract, declared as the ",(0,o.kt)("inlineCode",{parentName:"p"},"tokenId")),(0,o.kt)("p",null,"To allow deposits of ERC721 expressions of liquidity, create a struct called ",(0,o.kt)("inlineCode",{parentName:"p"},"Deposit"),", a mapping of ",(0,o.kt)("inlineCode",{parentName:"p"},"uint256")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"Deposit")," struct, then declare that mapping as a public variable ",(0,o.kt)("inlineCode",{parentName:"p"},"deposits"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"    struct Deposit {\n        address owner;\n        uint128 liquidity;\n        address token0;\n        address token1;\n    }\n\n    mapping(uint256 => Deposit) public deposits;\n")),(0,o.kt)("h2",{id:"the-constructor"},"The Constructor"),(0,o.kt)("p",null,"Declare the constructor here, which is executed once when the contract is deployed. Our constructor hard codes the address of the nonfungible position manager interface, V3 router, and the periphery immutable state constructor, which requires the factory and the address of weth9 (the ",(0,o.kt)("a",{parentName:"p",href:"https://weth.io/"},"ERC-20 wrapper")," for ether)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"    constructor(\n        INonfungiblePositionManager _nonfungiblePositionManager,\n        address _factory,\n        address _WETH9\n    ) PeripheryImmutableState(_factory, _WETH9) {\n        nonfungiblePositionManager = _nonfungiblePositionManager;\n    }\n")),(0,o.kt)("h2",{id:"allowing-custody-of-erc721-tokens"},"Allowing custody of ERC721 tokens"),(0,o.kt)("p",null,"To allow the contract to custody ERC721 tokens, implement the ",(0,o.kt)("inlineCode",{parentName:"p"},"onERC721Received")," function within the inherited ",(0,o.kt)("inlineCode",{parentName:"p"},"IERC721Receiver.sol")," ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/IERC721Receiver.sol"},"contract"),"."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"from")," identifier may be omitted because it is not used."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"    function onERC721Received(\n        address operator,\n        address,\n        uint256 tokenId,\n        bytes calldata\n    ) external override returns (bytes4) {\n        // get position information\n        _createDeposit(operator, tokenId);\n        return this.onERC721Received.selector;\n    }\n")),(0,o.kt)("h2",{id:"creating-a-deposit"},"Creating a Deposit"),(0,o.kt)("p",null,"To add a ",(0,o.kt)("inlineCode",{parentName:"p"},"Deposit")," instance to the ",(0,o.kt)("inlineCode",{parentName:"p"},"deposits")," mapping, create an internal function called ",(0,o.kt)("inlineCode",{parentName:"p"},"_createDeposit")," that destructures the ",(0,o.kt)("inlineCode",{parentName:"p"},"positions")," struct returned by ",(0,o.kt)("inlineCode",{parentName:"p"},"positions")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"nonfungiblePositionManager.sol"),". Pass the relevant variables ",(0,o.kt)("inlineCode",{parentName:"p"},"token0")," ",(0,o.kt)("inlineCode",{parentName:"p"},"token1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"liquidity")," to the ",(0,o.kt)("inlineCode",{parentName:"p"},"deposits")," mapping."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"    function _createDeposit(address owner, uint256 tokenId) internal {\n        (, , address token0, address token1, , , , uint128 liquidity, , , , ) =\n            nonfungiblePositionManager.positions(tokenId);\n\n        // set the owner and data for position\n        // operator is msg.sender\n        deposits[tokenId] = Deposit({owner: owner, liquidity: liquidity, token0: token0, token1: token1});\n    }\n\n")),(0,o.kt)("h2",{id:"the-full-contract-setup"},"The Full Contract Setup"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-solidity"},"// SPDX-License-Identifier: GPL-2.0-or-later\npragma solidity =0.7.6;\npragma abicoder v2;\n\nimport '@uniswap/v3-core/contracts/interfaces/IUniswapV3Pool.sol';\nimport '@uniswap/v3-core/contracts/libraries/TickMath.sol';\nimport '@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol';\nimport '../libraries/TransferHelper.sol';\nimport '../interfaces/INonfungiblePositionManager.sol';\nimport '../base/LiquidityManagement.sol';\n\ncontract LiquidityExamples is IERC721Receiver {\n    address public constant DAI = 0x6B175474E89094C44Da98b954EedeAC495271d0F;\n    address public constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;\n\n    uint24 public constant poolFee = 3000;\n\n    INonfungiblePositionManager public immutable nonfungiblePositionManager;\n\n    /// @notice Represents the deposit of an NFT\n    struct Deposit {\n        address owner;\n        uint128 liquidity;\n        address token0;\n        address token1;\n    }\n\n    /// @dev deposits[tokenId] => Deposit\n    mapping(uint256 => Deposit) public deposits;\n\n    constructor(\n        INonfungiblePositionManager _nonfungiblePositionManager\n    ) {\n        nonfungiblePositionManager = _nonfungiblePositionManager;\n    }\n\n    // Implementing `onERC721Received` so this contract can receive custody of erc721 tokens\n    function onERC721Received(\n        address operator,\n        address,\n        uint256 tokenId,\n        bytes calldata\n    ) external override returns (bytes4) {\n        // get position information\n\n        _createDeposit(operator, tokenId);\n\n        return this.onERC721Received.selector;\n    }\n\n    function _createDeposit(address owner, uint256 tokenId) internal {\n        (, , address token0, address token1, , , , uint128 liquidity, , , , ) =\n            nonfungiblePositionManager.positions(tokenId);\n\n        // set the owner and data for position\n        // operator is msg.sender\n        deposits[tokenId] = Deposit({owner: owner, liquidity: liquidity, token0: token0, token1: token1});\n    }\n}\n")))}d.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var i=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),g=o,m=u["".concat(l,".").concat(g)]||u[g]||d[g]||r;return n?i.createElement(m,a(a({ref:t},c),{},{components:n})):i.createElement(m,a({ref:t},c))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,a=new Array(r);a[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,a[1]=s;for(var p=2;p<r;p++)a[p]=n[p];return i.createElement.apply(null,a)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);