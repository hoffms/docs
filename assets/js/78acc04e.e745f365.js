"use strict";(self.webpackChunk_uniswap_docs=self.webpackChunk_uniswap_docs||[]).push([[17878],{56017:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=n(83117),r=(n(67294),n(3905));const i={title:"TransientStateLibrary"},l=void 0,o={unversionedId:"contracts/v4/reference/core/libraries/transient-state-library",id:"contracts/v4/reference/core/libraries/transient-state-library",title:"TransientStateLibrary",description:"The TransientStateLibrary is a crucial component of Uniswap V4, providing utility functions for managing transient state in the PoolManager contract. This library handles operations related to reserves, delta counts, and locking state, which are essential for the efficient and secure operation of the Uniswap V4 protocol.",source:"@site/docs/contracts/v4/reference/core/libraries/transient-state-library.mdx",sourceDirName:"contracts/v4/reference/core/libraries",slug:"/contracts/v4/reference/core/libraries/transient-state-library",permalink:"/docs/contracts/v4/reference/core/libraries/transient-state-library",editUrl:"https://github.com/uniswap/uniswap-docs/tree/main/docs/contracts/v4/reference/core/libraries/transient-state-library.mdx",tags:[],version:"current",frontMatter:{title:"TransientStateLibrary"},sidebar:"contractsSidebar",previous:{title:"LiquidityAmounts",permalink:"/docs/contracts/v4/reference/core/libraries/liquidity-amounts"},next:{title:"BalanceDelta",permalink:"/docs/contracts/v4/reference/core/types/BalanceDelta"}},s={},c=[{value:"Transient Storage",id:"transient-storage",level:2},{value:"getReserves",id:"getreserves",level:2},{value:"getNonzeroDeltaCount",id:"getnonzerodeltacount",level:2},{value:"currencyDelta",id:"currencydelta",level:2},{value:"isUnlocked",id:"isunlocked",level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"TransientStateLibrary")," is a crucial component of Uniswap V4, providing utility functions for managing transient state in the PoolManager contract. This library handles operations related to reserves, delta counts, and locking state, which are essential for the efficient and secure operation of the Uniswap V4 protocol."),(0,r.kt)("h1",{id:"key-concepts"},"Key Concepts"),(0,r.kt)("h2",{id:"transient-storage"},"Transient Storage"),(0,r.kt)("p",null,"Uniswap V4 uses transient storage to optimize gas costs and improve efficiency. Transient storage, introduced in EIP-1153, is a way to store data that is only needed for the duration of a transaction, without persisting it to the blockchain's state trie. This is achieved using the ",(0,r.kt)("inlineCode",{parentName:"p"},"TLOAD")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"TSTORE")," opcodes."),(0,r.kt)("p",null,"Key points about transient storage in Uniswap V4:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"PoolManager and")," ",(0,r.kt)("inlineCode",{parentName:"li"},"exttload"),": Instead of exposing custom getters for transient storage, the PoolManager implements an ",(0,r.kt)("inlineCode",{parentName:"li"},"exttload")," (external tload) function. This function serves as an external wrapper for the ",(0,r.kt)("inlineCode",{parentName:"li"},"TLOAD")," opcode, providing a standardized interface for accessing transient storage."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"TransientStateLibrary's Role:")," The ",(0,r.kt)("inlineCode",{parentName:"li"},"TransientStateLibrary")," acts as an intermediary, making calls to the PoolManager's ",(0,r.kt)("inlineCode",{parentName:"li"},"exttload")," function to access transient storage. This abstraction simplifies the interaction with transient storage for other parts of the Uniswap V4 ecosystem."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Standardization:")," By channeling all transient storage access through the PoolManager's ",(0,r.kt)("inlineCode",{parentName:"li"},"exttload")," function, Uniswap V4 ensures a consistent and controlled approach to managing transient data across the protocol.")),(0,r.kt)("p",null,"Common operations that involve transient state include:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Checking reserves (",(0,r.kt)("inlineCode",{parentName:"li"},"getReserves"),")"),(0,r.kt)("li",{parentName:"ul"},"Verifying currency deltas (",(0,r.kt)("inlineCode",{parentName:"li"},"currencyDelta"),")"),(0,r.kt)("li",{parentName:"ul"},"Syncing currency states (",(0,r.kt)("inlineCode",{parentName:"li"},"sync"),")"),(0,r.kt)("li",{parentName:"ul"},"Settling currency balances (",(0,r.kt)("inlineCode",{parentName:"li"},"settle"),")")),(0,r.kt)("p",null,"This architecture allows Uniswap V4 to benefit from the gas efficiency of transient storage while maintaining a clean and standardized interface for interacting with this temporary data."),(0,r.kt)("h1",{id:"functions"},"Functions"),(0,r.kt)("h2",{id:"getreserves"},"getReserves"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"function getReserves(IPoolManager manager, Currency currency) internal view returns (uint256)\n")),(0,r.kt)("p",null,"Retrieves the reserves of a specific currency from the PoolManager's transient storage."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Param Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"manager"),(0,r.kt)("td",{parentName:"tr",align:null},"IPoolManager"),(0,r.kt)("td",{parentName:"tr",align:null},"The PoolManager contract instance")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"currency"),(0,r.kt)("td",{parentName:"tr",align:null},"Currency"),(0,r.kt)("td",{parentName:"tr",align:null},"The currency for which to fetch reserves")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"uint256"),": The amount of reserves for the specified currency")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Notes:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Returns ",(0,r.kt)("inlineCode",{parentName:"li"},"0")," if the reserves are not synced"),(0,r.kt)("li",{parentName:"ul"},"Returns ",(0,r.kt)("inlineCode",{parentName:"li"},"type(uint256).max")," if the reserves are synced but the value is ",(0,r.kt)("inlineCode",{parentName:"li"},"0"))),(0,r.kt)("h2",{id:"getnonzerodeltacount"},"getNonzeroDeltaCount"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"function getNonzeroDeltaCount(IPoolManager manager) internal view returns (uint256)\n")),(0,r.kt)("p",null,"Retrieves the count of nonzero deltas that must be zeroed out before the contract can be locked."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Param Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"manager"),(0,r.kt)("td",{parentName:"tr",align:null},"IPoolManager"),(0,r.kt)("td",{parentName:"tr",align:null},"The PoolManager contract instance")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"uint256"),": The number of nonzero deltas")),(0,r.kt)("h2",{id:"currencydelta"},"currencyDelta"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"function currencyDelta(IPoolManager manager, address caller_, Currency currency) internal view returns (int256)\n")),(0,r.kt)("p",null,"Fetches the current delta for a specific caller and currency from the PoolManager's transient storage."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Param Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"manager"),(0,r.kt)("td",{parentName:"tr",align:null},"IPoolManager"),(0,r.kt)("td",{parentName:"tr",align:null},"The PoolManager contract instance")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"caller_"),(0,r.kt)("td",{parentName:"tr",align:null},"address"),(0,r.kt)("td",{parentName:"tr",align:null},"The address of the caller")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"currency"),(0,r.kt)("td",{parentName:"tr",align:null},"Currency"),(0,r.kt)("td",{parentName:"tr",align:null},"The currency for which to lookup the delta")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"int256"),": The delta value for the specified caller and currency")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Notes:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A ",(0,r.kt)("strong",{parentName:"li"},"negative")," delta indicates an amount that must be ",(0,r.kt)("strong",{parentName:"li"},"paid or settled")," by the caller. In other words, a negative delta means the caller owes that amount and needs to pay or settle it."),(0,r.kt)("li",{parentName:"ul"},"A ",(0,r.kt)("strong",{parentName:"li"},"positive")," delta indicates an amount that is owed to the caller. This delta amount must be ",(0,r.kt)("strong",{parentName:"li"},"taken or claimed")," by the caller.")),(0,r.kt)("h2",{id:"isunlocked"},"isUnlocked"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"function isUnlocked(IPoolManager manager) internal view returns (bool)\n")),(0,r.kt)("p",null,"Checks if the PoolManager contract is currently unlocked."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Param Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"manager"),(0,r.kt)("td",{parentName:"tr",align:null},"IPoolManager"),(0,r.kt)("td",{parentName:"tr",align:null},"The PoolManager contract instance")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"bool"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"true")," if the contract is unlocked, ",(0,r.kt)("inlineCode",{parentName:"li"},"false")," otherwise")),(0,r.kt)("h1",{id:"usage-and-importance"},"Usage and Importance"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"TransientStateLibrary")," plays a critical role in Uniswap V4's operation:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Gas Optimization:")," By using transient storage, the library helps reduce gas costs associated with state changes that are only relevant within a single transaction. This is particularly important for multi-hop transactions, where internal net balances (deltas) are updated instead of making token transfers for each hop."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Security:")," The library provides functions to check the lock state and manage deltas, which are crucial for maintaining the integrity of the protocol during operations. The use of transient storage also allows for more efficient implementation of security measures compared to V3's reentrancy guards."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Flexibility:")," The library allows for efficient management of currency-specific data, such as reserves and deltas, which is essential for Uniswap V4's multi-currency pools."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Encapsulation:")," By centralizing these utility functions in a library, the code promotes better organization and reusability across the Uniswap V4 codebase.")),(0,r.kt)("h1",{id:"integration-with-poolmanager"},"Integration with PoolManager"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"TransientStateLibrary")," is designed to work closely with the ",(0,r.kt)("inlineCode",{parentName:"p"},"PoolManager")," contract. The ",(0,r.kt)("inlineCode",{parentName:"p"},"TransientStateLibrary")," can be easily integrated with the ",(0,r.kt)("inlineCode",{parentName:"p"},"PoolManager")," contract using the ",(0,r.kt)("inlineCode",{parentName:"p"},"using")," keyword for syntactic sugar. This allows you to call the library functions as if they were methods of the ",(0,r.kt)("inlineCode",{parentName:"p"},"IPoolManager")," instance. Here's an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},'import {IPoolManager} from "v4-core/src/interfaces/IPoolManager.sol";\nimport {TransientStateLibrary} from "v4-core/src/libraries/TransientStateLibrary.sol";\n\ncontract Example {\n    using TransientStateLibrary for IPoolManager;\n\n    function example() external {\n        int256 delta = manager.currencyDelta(address(this), currency);\n        // Use the delta value...\n    }\n}\n')),(0,r.kt)("p",null,"In this example, the ",(0,r.kt)("inlineCode",{parentName:"p"},"using TransientStateLibrary for IPoolManager;")," statement allows you to call ",(0,r.kt)("inlineCode",{parentName:"p"},"currencyDelta")," directly on the ",(0,r.kt)("inlineCode",{parentName:"p"},"manager")," instance, making your code more readable and concise."))}u.isMDXComponent=!0},3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,k=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return n?a.createElement(k,l(l({ref:t},p),{},{components:n})):a.createElement(k,l({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);